{% extends 'base.html' %}
{% load bulma_tags %}
{% block app %}
  <div class="container is-fluid" v-if="'{{ user.is_authenticated }}' == 'True'">
    <div class="tile is-ancestor">
      <div class="tile is-2 is-vertical is-parent">
        <!-- List Menu -->
        <div class="tile is-child box">
          <div class="title">{{ user.username }}</div>
          <a class="button is-dark is-inverted is-fullwidth" @click="toggleInput" style="margin-top: auto">
            <i class="fas fa-plus" style="margin-right: 7px"></i> add new
          </a>
          <p class="menu-label" v-if="lists.length">
            todo lists
          </p>
          <ul>
            <li class="button is-fullwidth"
                :class="{ 'is-dark is-inverted': list != selectedList, 'is-primary is-disable': list == selectedList }"
                v-for="list in lists"
                @click="selectList(list)"
                style="margin-top: 10px;">
              [[ list.title ]]
            </li>
          </ul>
        </div>
      </div>
      <!-- Selected List -->
      <div class="tile is-parent">
        <div class="tile is-child box" v-if="!selectedList.todos">
          <p class="title">Create new list</p>
          <a class="button is-dark is-inverted is-fullwidth" @click="toggleInput" style="margin-top: auto">
            <i class="fas fa-plus" style="margin-right: 7px"></i> add new
          </a>
        </div>
        <div class="tile is-child box" v-else>
          <!-- List Title -->
          <p class="title">[[ selectedList.title ]]
            <a style="font-size: 1rem; margin: 5px;" @click="toggleTitle" class="has-text-black">
              <i class="far fa-edit"></i></a>
            <a style="font-size: 1rem;" @click="deleteList" class="has-text-black">
              <i class="far fa-trash-alt"></i></a>
          </p>
          <!-- Todos Input -->
          <input class="input" type="text" v-model="todoInput" placeholder="Add todo..."
                 @keyup.enter="createTodo(selectedList)">
          <!-- No Todos -->
          <aside class="menu" v-if="!selectedList.todos.length" style="margin-top: 10px;">
            <div class="div" style="margin-top: 30px">
              <span>
                <i class="fas fa-arrow-up" style="margin: 0 10px"></i>
                Input something to do, and press enter key
              </span>
            </div>
          </aside>
          <!-- Todos -->
          <aside class="menu" v-else style="margin-top: 10px;">
            <p class="menu-label"></p> <!-- for first-label margin control -->
            <!-- Stared & Not Finished -->
            <p class="menu-label" v-show="stared.length">
              Important
            </p>
            <ul class="menu-list">
              <li v-for="todo in stared">
                <a>
                  <span class="has-text-primary" @click="important(todo)"><i class="fas fa-star"></i></span>
                  <span class="" @click="check(todo)" style="margin-right: 10px"><i class="far fa-square"></i></span>
                  <span style="display: inline-block; width: 88%;" @click="toggleTodo(todo)">[[ todo.title ]]</span>
                </a>
              </li>
            </ul>
            <!-- Not Finished -->
            <p class="menu-label" v-show="notFinished.length">
              Todos
            </p>
            <ul class="menu-list">
              <li v-for="todo in notFinished">
                <a>
                  <span @click="important(todo)"><i class="far fa-star"></i></span>
                  <span @click="check(todo)" style="margin-right: 10px"><i class="far fa-square"></i></span>
                  <span style="display: inline-block; width: 88%;" @click="toggleTodo(todo)">[[ todo.title ]]</span>
                </a>
              </li>
            </ul>
            <!-- Finished -->
            <p class="menu-label" v-show="finished.length || staredFinished.length">
              Finished
            </p>
            <!-- Stared & Finished -->
            <ul class="menu-list" v-show="staredFinished.length">
              <li v-for="todo in staredFinished">
                <a>
                  <span class="has-text-primary" @click="important(todo)"><i class="fas fa-star"></i></span>
                  <span @click="check(todo)" style="margin-right: 10px"><i class="far fa-check-square"></i></span>
                  <span style="display: inline-block; width: 88%;" @click="toggleTodo(todo)">
                    <s>[[ todo.title ]]</s>
                  </span>
                </a>
              </li>
            </ul>
            <!-- Not Stared & Finished -->
            <ul class="menu-list" v-show="finished.length">
              <li v-for="todo in finished">
                <a>
                  <span @click="important(todo)"><i class="far fa-star"></i></span>
                  <span @click="check(todo)" style="margin-right: 10px"><i class="far fa-check-square"></i></span>
                  <span style="display: inline-block; width: 88%;" @click="toggleTodo(todo)">
                    <s>[[ todo.title ]]</s>
                  </span>
                </a>
              </li>
            </ul>
          </aside>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Page for Anonymous User -->
  <section class="hero is-fullheight is-primary is-bold" v-else>
    <div class="hero-body">
      <div class="container">
        <div class="columns">
          <div class="column is-one-third">
          </div>
          <div class="column">
            <h1 class="title">
              ㅇㅅㄹㅅㅌ Wookslist
            </h1>
            <h2 class="subtitle">
              Plan Your Life and Never Be Stuck Again
            </h2>
            <a class="button is-light is-medium" href="{% url 'accounts:signup' %}">
              <span>Sign up, and join us</span>
            </a>
            <a class="button is-light is-outlined is-medium" href="{% url 'accounts:login' %}">
              <span>Login</span>
            </a>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Modal -->
  <div class="modal" :class="{'is-active':toggle}">
    <div class="modal-background"></div>
    <div class="modal-card">
      <!-- Add List Modal -->
      <section class="modal-card-body" v-show="toggleType==='input'">
        <p class="title">New list</p>
        <input class="input" type="text" placeholder="title input" v-model="listInput" @keydown.enter="createList"
               style="margin-bottom: 20px">
        <button class="button is-primary" @click="createList">Add</button>
        <button class="button" @click="toggleInput">Cancel</button>
      </section>
      <!-- Edit Title Modal -->
      <section class="modal-card-body" v-show="toggleType==='title'">
        <p class="title">Edit title</p>
        <input class="input" type="text" placeholder="title input" v-model="changeTitle" @keydown.enter="changeList"
               style="margin-bottom: 20px">
        <button class="button is-primary" @click="changeList">Update</button>
        <button class="button" @click="toggleTitle">Cancel</button>
      </section>
      <!-- Todos Detail Modal -->
      <section class="modal-card-body" v-show="toggleType==='todo'">
        <p class="title" style="display: flex;">
          [[ selectedTodo.title ]]
          <span style="margin-left: auto;"></span>
          <a style="font-size: 1.15rem; margin-right: 10px;" class="has-text-black" v-show="!edit" @click="edit=true">
            <i class="far fa-edit"></i></a>
          <a style="font-size: 1.15rem; margin-right: 12px;" class="has-text-black" @click="deleteTodo(selectedTodo)">
            <i class="far fa-trash-alt"></i></a>
          <button class="delete" aria-label="close" @click="toggleTodo(selectedTodo)"></button>
        </p>
        <div class="box" v-show="!edit">
          view
        </div>
        <div class="box" v-show="edit">
          <div class="field">
            <p class="control has-icons-left has-icons-right">
              <input class="input" type="email" placeholder="Set due date" v-model="selectedTodo.deadline">
              <span class="icon is-small is-left">
                <i class="fas fa-envelope"></i>
              </span>
            </p>
          </div>
          <div class="field">
            <p class="control has-icons-left">
              <input class="input" type="password" placeholder="Password">
              <span class="icon is-small is-left">
                <i class="fas fa-lock"></i>
              </span>
            </p>
          </div>
        </div>
        <div>
          <button class="button is-primary" v-show="edit" @click="changeTodo">Update</button>
          <button class="button" v-show="edit" @click="edit=false">Cancel</button>
        </div>
      </section>
    </div>
  </div>
{% endblock %}
{% block script %}
  <script>
    axios.defaults.xsrfCookieName = 'csrftoken';
    axios.defaults.xsrfHeaderName = 'X-CSRFToken';
    const app = new Vue({
      delimiters: ['[[', ']]'],
      el: '#app',
      data: {
        lists: [],
        selectedList: [],
        selectedTodo: [],
        listInput: '',
        todoInput: '',
        detailInput: '',
        changeTitle: '',
        toggle: false,
        edit: false,
        toggleType: '',
      },
      methods: {
        toggleTodo: function (todo) {
          if (this.toggle) {
            this.toggle = false;
            this.toggleType = ''
          } else {
            this.toggle = true;
            this.toggleType = 'todo';
            this.selectedTodo = todo;
          }
        },
        toggleTitle: function () {
          if (this.toggle) {
            this.toggle = false;
            this.toggleType = ''
          } else {
            this.toggle = true;
            this.toggleType = 'title';
            this.changeTitle = this.selectedList.title;
          }
        },
        toggleInput: function () {
          if (this.toggle) {
            this.toggle = false;
            this.toggleType = ''
          } else {
            this.toggle = true;
            this.toggleType = 'input'
          }
        },
        createList: function () {
          if (this.listInput) {
            axios.post("{% url 'todos:lists_list' %}", {
              title: this.listInput,
            }).then((res) => {
              console.log('Save list');
              const list = res.data;
              this.lists.push(list);
              this.selectedList = list;
            });
            this.listInput = '';
            this.toggle = false;
          } else {
            console.log('Nothing to submit')
          }
        },
        createTodo: function (list) {
          if (this.todoInput) {
            axios.post("{% url 'todos:todos_list' %}", {
              title: this.todoInput,
              list: list.id,
            }).then((res) => {
              console.log('Save todo');
              const todo = res.data;
              list.todos.unshift(todo);
              this.edit = true;
              this.toggleTodo(todo);
            });
            this.todoInput = '';
          } else {
            console.log('Nothing to submit')
          }
        },
        createDetail: function (todo) {
          if (this.detailInput) {
            let url = "{% url 'todos:details_list' 0 %}";
            url = url.replace('0', `${todo.id}`);
            axios.post(url, {
              content: this.detailInput,
              todo: todo.id,
            }).then((res) => {
              console.log('Save detail');
              const detail = res.data;
              todo.details.push(detail);
            });
            this.detailInput = '';
          } else {
            console.log('Nothing to submit')
          }
        },
        selectList: function (list) {
          this.selectedList = list;
        },
        check: function (todo) {
          axios.get("{% url 'todos:todos_check' 123 %}".replace('123', `${todo.id}`))
            .then(res => todo.check = res.data.check);
        },
        important: function (todo) {
          axios.get("{% url 'todos:todos_important' 123 %}".replace('123', `${todo.id}`))
            .then(res => todo.important = res.data.important);
        },
        changeTodo: function () {
          axios.get(
            "{% url 'todos:todos_detail' 123 %}".replace('123', `${this.selectedTodo.id}`))
            .then(res => {
              console.log(res.data);
            });
        },
        deleteTodo: function () {
          const result = confirm(`"${this.selectedTodo.title}" will be deleted forever.`);
          if (result) {
            axios.delete("{% url 'todos:todos_detail' 123 %}".replace('123', `${this.selectedTodo.id}`))
              .then(res => {
                this.selectedList.todos = this.selectedList.todos.filter(todo => todo !== this.selectedTodo);
                this.selectedTodo = [];
                this.toggle = false;
                this.toggleType = '';
              })
          }
        },
        changeList: function () {
          axios.patch(
            "{% url 'todos:lists_detail' 123 %}".replace('123', `${this.selectedList.id}`),
            {'title': this.changeTitle})
            .then(res => {
              this.selectedList.title = res.data.title;
              this.changeTitle = '';
              this.toggle = false;
              this.toggleType = '';
            });
        },
        deleteList: function () {
          const result = confirm(`"${this.selectedList.title}" will be deleted forever.`);
          if (result) {
            axios.delete("{% url 'todos:lists_detail' 123 %}".replace('123', `${this.selectedList.id}`))
              .then(res => {
                this.lists = this.lists.filter(list => list !== this.selectedList);
                if (this.lists.length) {
                  this.selectedList = this.lists[0];
                } else {
                  this.selectedList = [];
                }
              })
          }
        },
      },
      created: function () {
        let url = "{% url "accounts:profile" "foobar" %}";
        if ("{{ user.is_authenticated }}" === "True") {
          url = url.replace("foobar", "{{ user.username }}");
          axios.get(url)
            .then(res => {
              this.lists = res.data.lists;
            })
            .then(res => {
              if (this.lists.length) {
                this.selectedList = this.lists[0];
              } else {
                this.selectedList = [];
              }
            });
        }
      },
      computed: {
        stared: function () {
          if (this.selectedList && this.selectedList.todos) {
            return this.selectedList.todos.filter(todo => todo.important && !todo.check)
          } else {
            return []
          }
        },
        notFinished: function () {
          if (this.selectedList && this.selectedList.todos) {
            return this.selectedList.todos.filter(todo => !todo.important && !todo.check)
          } else {
            return []
          }
        },
        staredFinished: function () {
          if (this.selectedList && this.selectedList.todos) {
            return this.selectedList.todos.filter(todo => todo.important && todo.check)
          } else {
            return []
          }
        },
        finished: function () {
          if (this.selectedList && this.selectedList.todos) {
            return this.selectedList.todos.filter(todo => !todo.important && todo.check)
          } else {
            return []
          }
        },
      }
    });
  </script>
{% endblock %}